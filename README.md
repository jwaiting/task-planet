# TaskPlanet Backend

Crow (C++) backend for TaskPlanet: mood/context-driven task suggestions with a suggestion-buffer and lightweight learning.

---

## Overview

* **Stack**: C++17, [Crow](https://github.com/CrowCpp/Crow) (HTTP), libpqxx (PostgreSQL), CMake
* **DB**: PostgreSQL (snake\_case schema), `pg_trgm` extension, Prisma for migrations
* **Config**: `.env` via dotenv-cpp
* **Key features**:

  * `/api/tags` – fetch active tag catalog
  * `/api/suggest` – recommend tasks based on tags + time
  * `/api/suggestions/buffer` – submit user suggestions (auto-merge if similar)
  * `/api/events` – feedback (`adopt`/`skip`/`impression`) to update weights
  * CORS enabled; unified JSON error shape `{ error, hint }`

---

## Prerequisites

* **PostgreSQL** 13+ (with `pg_trgm` extension available)
* **CMake** 3.10+
* **Compiler**: clang++/g++ with C++17
* **libpq / libpqxx** installed and discoverable (e.g., `/usr/local/include`, `/usr/local/lib`)

> Note: Prisma is used only to manage migrations. The C++ service connects directly to Postgres via libpq DSN.

---

## Environment Setup

1. Copy the example env file:

   ```bash
   cp .env.example .env
   ```

2. Run the init script to generate a secure `AUTH_JWT_SECRET` (macOS/Linux):

   ```bash
   ./init_env.sh
   ```

3. Make sure `.env` is **not committed** (already ignored by `.gitignore`).

---

### Required Variables

#### Database

* `DB_NAME` – Database name
* `DB_USER` – Database user
* `DB_PASSWORD` – User password
* `DB_HOST` – Database host (usually `localhost`)
* `DB_PORT` – Database port (default: `5432`)
* `DB_SCHEMA` – optional, defaults to `public`
* `PORT` – optional, defaults to `8080`

#### Authentication (JWT)

* `AUTH_JWT_SECRET` – Secret key used to sign tokens (auto-generated by `init_env.sh`)
* `AUTH_ISS` – JWT issuer (default: `taskplanet-api`)
* `AUTH_AUD` – JWT audience (default: `taskplanet-web`)

> The backend **does not** use Prisma-style URLs with `?schema=`. Schema is set via `DB_SCHEMA` and applied as `SET search_path TO <schema>, public` per connection.

---

## Install & Run

### Quick start

```bash
# Build & run (Release by default)
./build_and_run.sh

# In another terminal: quick smoke tests
./smoke.sh
```

### Manual build

```bash
cmake -S . -B build -DCMAKE_BUILD_TYPE=Release
cmake --build build -j
./build/task_planet
```

---

## Database & Migrations

* Enable `pg_trgm` and create supporting indexes/triggers via Prisma migration:

  * `migrations/<ts>_infra_trgm_indexes_triggers/migration.sql`
* Apply:

```bash
npx prisma migrate dev
```

* If `CREATE EXTENSION pg_trgm` needs superuser, run once with a superuser:

```bash
psql -h localhost -U <superuser> -d taskplanet_tagfit -c 'CREATE EXTENSION IF NOT EXISTS pg_trgm;'
```

---

## API

Base URL: `http://localhost:${PORT:-8080}`

### Health

`GET /ping` → `pong`

### Tags

`GET /api/tags`

```json
{
  "tags": [
    {"id": 1, "code": "context/desk", "label": "在桌前", "group": "context"},
    ...
  ]
}
```

### Suggest tasks

`POST /api/suggest`

```json
{
  "tagCodes": ["context/desk", "focus/high"],
  "time": 20,
  "limit": 10
}
```

Response:

```json
{
  "tasks": [
    {
      "id": 12,
      "description": "寫下三件感恩小事",
      "suggestedTime": 10,
      "tagFit": 0.73,
      "timeFit": 0.86,
      "finalScore": 0.78
    }
  ]
}
```

### Submit suggestion

`POST /api/suggestions/buffer`

```json
{
  "description": "散步 10 分鐘",
  "suggestedTime": 10,
  "tagCodes": ["context/outdoor", "energy/med"]
}
```

Response (merge hit):

```json
{ "merged": true, "suggestionId": 44, "matchedTaskId": 5, "similarity": 0.91 }
```

Response (queued):

```json
{ "merged": false, "suggestionId": 45 }
```

### Feedback events

`POST /api/events`

```json
{ "taskId": 5, "event": "adopt", "tagCodes": ["context/desk", "focus/high"] }
```

* `adopt`: reinforce `(task, tag)` (alpha += 1)
* `skip`/`impression`: light negative signal (beta += 1)

Errors:

* JSON error envelope: `{ "error": "...", "hint": "..." }`

---

## Development

* **Prepared statements** are registered once per pooled connection (in pool initializer). **Do not** re-register in controllers.
* **SQL style**: snake\_case tables and columns throughout.
* **CORS** is enabled via middleware.

### Scripts

* `build_and_run.sh` – configurable via `BUILD_DIR`, `BUILD_TYPE`, `GENERATOR`
* `smoke.sh` – basic end-to-end API checks

---

## Project structure

```
src/
  app/
    server.cpp            # entrypoint
    middleware.hpp        # CORS
    routes.hpp            # (optional) central route mounting
  config/
    config.hpp            # dotenv + env access + DB DSN + schema + port
  db/
    pool.hpp              # pqxx connection pool
    prepared.hpp          # prepared SQL (snake_case)
  repositories/
    task_repo.hpp
    suggestion_repo.hpp
    weight_repo.hpp
    tag_repo.hpp
    stats_repo.hpp        # (todo)
  services/
    recommend_service.hpp
    suggestion_service.hpp
    event_service.hpp
  controllers/
    suggest_controller.hpp
    suggestions_controller.hpp
    events_controller.hpp
    tags_controller.hpp
    admin_controller.hpp  # (todo)
  domain/
    task.hpp              # (todo) domain structs
    types.hpp             # (todo) enums/aliases
  dto/
    request.hpp           # (todo) inbound shape helpers
    response.hpp          # (todo) error helpers
```

---

## Troubleshooting

* **`invalid URI query parameter: "schema"`**: Don’t use Prisma-style URLs. Use DSN via `.env` (DB\_\* vars). Service sets `search_path` from `DB_SCHEMA`.
* **`function similarity(text, text) does not exist`**: Install `pg_trgm` in the database.
* **`prepared statement "..." already exists`**: Ensure `register_prepared` is only called from the pool initializer (not in controllers).
* **`syntax error near "{"` with ANY(...)**: Pass array via parameterized query (`$1::text[]` / `$1::int[]`).

---

## Roadmap (short)

* `/api/suggest`: support `excludeTaskIds`
* `/api/suggestions/buffer`: return `matchedTask` fields on merge
* Admin endpoints for reviewing the buffer
* Daily maintenance job: decay `alpha/beta`; refresh `task_stats`

---

## License

MIT (see `LICENSE`).

---

## Local development – quick commands

```bash
# Build & run (Release) – defaults are configurable via env vars
./build_and_run.sh

# Build & run (Debug)
BUILD_TYPE=Debug ./build_and_run.sh

# Use Ninja instead of Make
GENERATOR=Ninja ./build_and_run.sh

# Smoke tests (can pass base URL)
./smoke.sh            # default http://localhost:8080
./smoke.sh http://127.0.0.1:9090
```

If you don’t have `jq`, use Python to pretty-print:

```bash
curl -sS <url> | python3 -m json.tool
```

---

## API field reference

(keep existing sections as you had them, unchanged)

---

## Admin (planned)

* `GET /admin/suggestions?...` – list suggestions
* `POST /admin/suggestions/{id}/approve` – create task, mark approved
* `POST /admin/suggestions/{id}/merge` – merge into task `{ taskId }`
* `POST /admin/suggestions/{id}/reject` – mark rejected

---

## Deployment notes

* Run behind a reverse proxy for TLS & routing.
* Set env vars via systemd, Docker, or your process manager.
* Ensure `pg_trgm` is installed once by a privileged role.

---

## Security

* Limit request body size.
* Validate required fields; return JSON error envelope.
* Restrict CORS in production.
* Rate-limiting on write endpoints (planned).

---

## Performance tips

* Use `pg_trgm` indexes.
* Batch writes in transactions.

---

## Conventions

* **Commits**: Conventional Commits in English.
* **Code style**: header-only okay for now; split later.
* **SQL**: always parameterize.

---

## Maintenance job (daily)

(keep your existing SQL decay & refresh snippet)

---
